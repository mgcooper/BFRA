<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of getevents</title>
  <meta name="keywords" content="getevents">
  <meta name="description" content="GETEVENTS get individual recession events from daily timeseries T, Q, and R.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../function_index.html">Home</a> &gt;  <a href="function_index.html">+bfra</a> &gt; getevents.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../function_index.html"><img alt="<" border="0" src="../html_img/left.png">&nbsp;Master index</a></td>
<td align="right"><a href="function_index.html">Index for +bfra&nbsp;<img alt=">" border="0" src="../html_img/right.png"></a></td></tr></table>-->

<h1>getevents
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<div class="box"><strong>GETEVENTS get individual recession events from daily timeseries T, Q, and R.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<div class="box"><strong>function [Events,Info] = getevents(T,Q,R,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<div class="fragment"><pre class="comment">GETEVENTS get individual recession events from daily timeseries T, Q, and R.

 Syntax

     Events = getevents(T,Q,R,varargin)

 Description

     Events = getevents(T,Q,R) Detects, processes, and organizes individual
     recession events from daily hydrograph timeseries T, Q, and rainfall R
     using default algorithm options. Event discharge, timestamps, and
     diagnostic info about the events are returned in output structure Events.
     Note: this function is a wrapper around eventfinder to perform pre- and
     post-processing and organize all recession events into the Events
     structure.

     Events = getevents(___,opts) uses user-defined options. See bfra.setopts
     for default options and optional values.

     [Events,Info] = getevents(___) also returns struct Info which contains the
     indices of the identified local maxima, minima, convex points, candidate
     recession values, kept recession values, and the start and stop index of
     each kept event. Use this information with bfra.eventplotter.

     Tip: events are identified by their indices on the t,q,r arrays, so if
     any filtering is applied prior to passing in the arrays, the data needs
     to be used in subsequent functions or the indices won't be correct

 Required inputs

     T     time, nx1 vector of datetimes
     Q     flow, nx1 vector of discharge (length/time) (assumed m3/day/day)
     R     rain, nx1 vector of rainfall (length/time) (assumed mm/day)

 Optional name-value inputs

     opts        (optional) structure containing the following fields:
     qmin        minimum flow value, below which values are set nan
     nmin        minimum event length
     fmax        maximum # of missing values gap-filled
     rmax        maximum run of sequential constant values
     rmin        minimum rainfall required to censor flow (mm/day?)
     cmax        maximum run of sequential convex dQ/dt values
     rmconvex    remove convex derivatives
     rmnochange  remove consecutive constant derivates
     rmrain      remove rainfall
     pickevents  option to manually pick events
     plotevents  option to plot picked events

 See also <a href="fitevents.html" class="code" title="function [Fits,Results] = fitevents(Events,varargin)">fitevents</a>, <a href="eventfinder.html" class="code" title="function [T,Q,R,Info] = eventfinder(t,q,r,varargin)">eventfinder</a>, <a href="eventsplitter.html" class="code" title="function [T,Q,R,Info] = eventsplitter(t,q,r,varargin)">eventsplitter</a>, <a href="eventpicker.html" class="code" title="function [T,Q,R,Info] = eventpicker(t,q,r,nmin,Info)">eventpicker</a>, <a href="eventplotter.html" class="code" title="function [h,f] = eventplotter(T,Q,R,Info,varargin)">eventplotter</a>

 Matt Cooper, 04-Nov-2022, https://github.com/mgcooper

 Note to users: for data-heavy workflows, replace the Events output struct
 with the eventTags list. The Events struct includes the input data and the
 event-data for convenience, but the event-data can be easily extracted from
 the input data using the eventTags.</pre></div>


<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>

This function calls:
<ul style="list-style-image:url(../html_img/matlabicon.gif)">
</ul>


This function is called by:
<ul style="list-style-image:url(../html_img/matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<ul style="list-style-image:url(../html_img/matlabicon.gif)">

<li><a href="#_sub1" class="code">function Info = updateinfo(Info,ifirst,numdata)</a></li>
<li><a href="#_sub2" class="code">function [qmin, nmin, fmax, rmax, rmin, cmax, rmconvex, rmnochange, rmrain,</a></li></ul>



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [Events,Info] = getevents(T,Q,R,varargin)</a>
0002 <span class="comment">%GETEVENTS get individual recession events from daily timeseries T, Q, and R.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Syntax</span>
0005 <span class="comment">%</span>
0006 <span class="comment">%     Events = getevents(T,Q,R,varargin)</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% Description</span>
0009 <span class="comment">%</span>
0010 <span class="comment">%     Events = getevents(T,Q,R) Detects, processes, and organizes individual</span>
0011 <span class="comment">%     recession events from daily hydrograph timeseries T, Q, and rainfall R</span>
0012 <span class="comment">%     using default algorithm options. Event discharge, timestamps, and</span>
0013 <span class="comment">%     diagnostic info about the events are returned in output structure Events.</span>
0014 <span class="comment">%     Note: this function is a wrapper around eventfinder to perform pre- and</span>
0015 <span class="comment">%     post-processing and organize all recession events into the Events</span>
0016 <span class="comment">%     structure.</span>
0017 <span class="comment">%</span>
0018 <span class="comment">%     Events = getevents(___,opts) uses user-defined options. See bfra.setopts</span>
0019 <span class="comment">%     for default options and optional values.</span>
0020 <span class="comment">%</span>
0021 <span class="comment">%     [Events,Info] = getevents(___) also returns struct Info which contains the</span>
0022 <span class="comment">%     indices of the identified local maxima, minima, convex points, candidate</span>
0023 <span class="comment">%     recession values, kept recession values, and the start and stop index of</span>
0024 <span class="comment">%     each kept event. Use this information with bfra.eventplotter.</span>
0025 <span class="comment">%</span>
0026 <span class="comment">%     Tip: events are identified by their indices on the t,q,r arrays, so if</span>
0027 <span class="comment">%     any filtering is applied prior to passing in the arrays, the data needs</span>
0028 <span class="comment">%     to be used in subsequent functions or the indices won't be correct</span>
0029 <span class="comment">%</span>
0030 <span class="comment">% Required inputs</span>
0031 <span class="comment">%</span>
0032 <span class="comment">%     T     time, nx1 vector of datetimes</span>
0033 <span class="comment">%     Q     flow, nx1 vector of discharge (length/time) (assumed m3/day/day)</span>
0034 <span class="comment">%     R     rain, nx1 vector of rainfall (length/time) (assumed mm/day)</span>
0035 <span class="comment">%</span>
0036 <span class="comment">% Optional name-value inputs</span>
0037 <span class="comment">%</span>
0038 <span class="comment">%     opts        (optional) structure containing the following fields:</span>
0039 <span class="comment">%     qmin        minimum flow value, below which values are set nan</span>
0040 <span class="comment">%     nmin        minimum event length</span>
0041 <span class="comment">%     fmax        maximum # of missing values gap-filled</span>
0042 <span class="comment">%     rmax        maximum run of sequential constant values</span>
0043 <span class="comment">%     rmin        minimum rainfall required to censor flow (mm/day?)</span>
0044 <span class="comment">%     cmax        maximum run of sequential convex dQ/dt values</span>
0045 <span class="comment">%     rmconvex    remove convex derivatives</span>
0046 <span class="comment">%     rmnochange  remove consecutive constant derivates</span>
0047 <span class="comment">%     rmrain      remove rainfall</span>
0048 <span class="comment">%     pickevents  option to manually pick events</span>
0049 <span class="comment">%     plotevents  option to plot picked events</span>
0050 <span class="comment">%</span>
0051 <span class="comment">% See also fitevents, eventfinder, eventsplitter, eventpicker, eventplotter</span>
0052 <span class="comment">%</span>
0053 <span class="comment">% Matt Cooper, 04-Nov-2022, https://github.com/mgcooper</span>
0054 <span class="comment">%</span>
0055 <span class="comment">% Note to users: for data-heavy workflows, replace the Events output struct</span>
0056 <span class="comment">% with the eventTags list. The Events struct includes the input data and the</span>
0057 <span class="comment">% event-data for convenience, but the event-data can be easily extracted from</span>
0058 <span class="comment">% the input data using the eventTags.</span>
0059 
0060 <span class="comment">% if called with no input, open this file</span>
0061 <span class="keyword">if</span> nargin == 0; open(mfilename(<span class="string">'fullpath'</span>)); <span class="keyword">return</span>; <span class="keyword">end</span>
0062 
0063 <span class="comment">% PARSE INPUTS</span>
0064 [qmin, nmin, fmax, rmax, rmin, ~, rmconvex, rmnochange, rmrain, <span class="keyword">...</span>
0065    pickevents, plotevents, asannual, T, Q, R] = parseinputs(mfilename, <span class="keyword">...</span>
0066    T, Q, R, varargin{:});
0067 
0068 <span class="comment">% save the input data</span>
0069 Events.inputTime = T;
0070 Events.inputFlow = Q;
0071 Events.inputRain = R;
0072 
0073 <span class="comment">% iF is the first non-nan index, to recover indices after removing nans</span>
0074 numdata     = numel(T);
0075 Q(Q&lt;qmin)   = nan;                              <span class="comment">% set values &lt; qmin nan</span>
0076 Q           = bfra.util.setconstantnan(Q,rmax); <span class="comment">% set constant non-nan values nan</span>
0077 [T,Q,R,iF]  = bfra.util.rmleadingnans(T,Q,R);   <span class="comment">% remove leading nans</span>
0078 [T,Q,R]     = bfra.util.rmtrailingnans(T,Q,R);  <span class="comment">% remove trailing nans</span>
0079 Q           = bfra.util.fillnans(Q,fmax);       <span class="comment">% gap fill missing values</span>
0080 
0081 <span class="comment">% smooth measurement noise</span>
0082 <span class="keyword">if</span> asannual
0083    Q = bfra.util.smoothflow(Q);
0084 <span class="keyword">end</span>
0085 
0086 
0087 <span class="keyword">if</span> isempty(Q)||sum(~isnan(Q))&lt;nmin <span class="comment">% fast exit</span>
0088    [t,q,r,Info] = bfra.util.setEventEmpty();
0089 
0090 <span class="keyword">else</span>
0091    <span class="comment">% call eventfinder either way, then update if pickfits == true</span>
0092    [t,q,r,Info] = bfra.eventfinder(T,Q,R, <span class="keyword">...</span>
0093       <span class="string">'nmin'</span>,        nmin,          <span class="keyword">...</span>
0094       <span class="string">'fmax'</span>,        fmax,          <span class="keyword">...</span>
0095       <span class="string">'rmax'</span>,        rmax,          <span class="keyword">...</span>
0096       <span class="string">'rmin'</span>,        rmin,          <span class="keyword">...</span>
0097       <span class="string">'rmconvex'</span>,    rmconvex,      <span class="keyword">...</span>
0098       <span class="string">'rmnochange'</span>,  rmnochange,    <span class="keyword">...</span>
0099       <span class="string">'rmrain'</span>,      rmrain         );
0100 
0101    Info = <a href="#_sub1" class="code" title="subfunction Info = updateinfo(Info,ifirst,numdata)">updateinfo</a>(Info,iF,numdata);
0102 
0103    <span class="comment">% NOTE: eventpicker doesn't update Info for events that are picked</span>
0104    <span class="comment">% within an eventfinder event, but only Info.istart is used in the</span>
0105    <span class="comment">% main algorithm so it is sufficient at this point</span>
0106    <span class="keyword">if</span> pickevents == true
0107       [t,q,r,Info] = bfra.eventpicker(T,Q,R,nmin,Info);
0108    <span class="keyword">elseif</span> plotevents == true
0109       Info.hEvents = bfra.eventplotter(T,Q,R,Info,<span class="string">'plotevents'</span>,plotevents);
0110    <span class="keyword">end</span>
0111 <span class="keyword">end</span>
0112 
0113 <span class="comment">% if asannual == false</span>
0114    [ <span class="keyword">...</span>
0115       Events.eventTime, <span class="keyword">...</span>
0116       Events.eventFlow, <span class="keyword">...</span>
0117       Events.eventRain, <span class="keyword">...</span>
0118       Events.eventTags] = bfra.flattenevents(t,q,r,Info);
0119 <span class="comment">% end</span>
0120 
0121 
0122 <a name="_sub1" href="#_subfunctions" class="code">function Info = updateinfo(Info,ifirst,numdata)</a>
0123 
0124 fields = fieldnames(Info);
0125 
0126 <span class="keyword">for</span> m = 1:numel(fields)
0127    Info.(fields{m}) = Info.(fields{m}) + ifirst - 1;
0128 <span class="keyword">end</span>
0129 
0130 Info.runlengths   = Info.istop - Info.istart + 1;
0131 Info.ifirst       = ifirst;
0132 Info.datalength   = numdata;
0133 
0134 <span class="comment">%% INPUT PARSER</span>
0135 <a name="_sub2" href="#_subfunctions" class="code">function [qmin, nmin, fmax, rmax, rmin, cmax, rmconvex, rmnochange, rmrain, </a><span class="keyword">...</span>
0136    pickevents, plotevents, asannual, T, Q, R] = parseinputs(mfilename, <span class="keyword">...</span>
0137    T, Q, R, varargin)
0138 
0139 <span class="keyword">persistent</span> parser
0140 <span class="keyword">if</span> isempty(parser)
0141    parser = inputParser;
0142    parser.StructExpand = true;
0143    parser.PartialMatching = false;
0144    parser.CaseSensitive = true;
0145 
0146    parser.addRequired(<span class="string">'T'</span>, @bfra.validation.isdatelike);
0147    parser.addRequired(<span class="string">'Q'</span>, @isnumeric);
0148    parser.addRequired(<span class="string">'R'</span>, @isnumeric);
0149 
0150    parser.addParameter(<span class="string">'qmin'</span>, 1, @bfra.validation.isnumericscalar);
0151    parser.addParameter(<span class="string">'nmin'</span>, 4, @bfra.validation.isnumericscalar);
0152    parser.addParameter(<span class="string">'fmax'</span>, 2, @bfra.validation.isnumericscalar);
0153    parser.addParameter(<span class="string">'rmax'</span>, 2, @bfra.validation.isnumericscalar);
0154    parser.addParameter(<span class="string">'rmin'</span>, 0, @bfra.validation.isnumericscalar);
0155    parser.addParameter(<span class="string">'cmax'</span>, 2, @bfra.validation.isnumericscalar);
0156    parser.addParameter(<span class="string">'rmconvex'</span>, false, @bfra.validation.islogicalscalar);
0157    parser.addParameter(<span class="string">'rmnochange'</span>, false, @bfra.validation.islogicalscalar);
0158    parser.addParameter(<span class="string">'rmrain'</span>, false, @bfra.validation.islogicalscalar);
0159    parser.addParameter(<span class="string">'pickevents'</span>, false, @bfra.validation.islogicalscalar);
0160    parser.addParameter(<span class="string">'plotevents'</span>, false, @bfra.validation.islogicalscalar);
0161    parser.addParameter(<span class="string">'asannual'</span>, false, @bfra.validation.islogicalscalar);
0162 <span class="keyword">end</span>
0163 parser.FunctionName = [<span class="string">'bfra.'</span> mfilename];
0164 parser.parse(T, Q, R, varargin{:});
0165 
0166 qmin = parser.Results.qmin;
0167 nmin = parser.Results.nmin;
0168 fmax = parser.Results.fmax;
0169 rmax = parser.Results.rmax;
0170 rmin = parser.Results.rmin;
0171 cmax = parser.Results.cmax;
0172 rmrain = parser.Results.rmrain;
0173 rmconvex = parser.Results.rmconvex;
0174 rmnochange = parser.Results.rmnochange;
0175 pickevents = parser.Results.pickevents;
0176 plotevents = parser.Results.plotevents;
0177 asannual = parser.Results.asannual;
0178 
0179 <span class="comment">% Require T and Q same size but allow empty R (syntax: getevents(T,Q,[],...) )</span>
0180 validateattributes(T, {<span class="string">'double'</span>}, {<span class="string">'size'</span>, size(Q)}, mfilename, <span class="string">'T'</span>, 1)
0181 validateattributes(nmin, {<span class="string">'double'</span>}, {<span class="string">'&gt;'</span>, 2}, mfilename, <span class="string">'nmin'</span>, 4)
0182 <span class="keyword">if</span> isempty(R)
0183    R = zeros(size(Q));
0184 <span class="keyword">end</span></pre></div>
</body>
</html>