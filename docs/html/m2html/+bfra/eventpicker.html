<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of eventpicker</title>
  <meta name="keywords" content="eventpicker">
  <meta name="description" content="EVENTPICKER automated or user-guided recession event selection">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../function_index.html">Home</a> &gt;  <a href="function_index.html">+bfra</a> &gt; eventpicker.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../function_index.html"><img alt="<" border="0" src="../html_img/left.png">&nbsp;Master index</a></td>
<td align="right"><a href="function_index.html">Index for +bfra&nbsp;<img alt=">" border="0" src="../html_img/right.png"></a></td></tr></table>-->

<h1>eventpicker
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<div class="box"><strong>EVENTPICKER automated or user-guided recession event selection</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<div class="box"><strong>function [T,Q,R,Info] = eventpicker(t,q,r,nmin,Info) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<div class="fragment"><pre class="comment">EVENTPICKER automated or user-guided recession event selection 
 
 Syntax
 
     [T,Q,R,Info] = eventpicker(t,q,r,nmin,Info)
 
 Description
 
     [T,Q,R,Info] = eventpicker(t,q,r,nmin,Info) selects recession events from
     input hydrograph with time 't', discharge 'q', and rain 'r'. Use optional
     inputs to set parameters that determine how events are identified and   
 
 Required inputs
 
     t        time
     q        flow (m3/time)
     r        rain (mm/time)
     nmin     minimum event length
 
 See also: <a href="getevents.html" class="code" title="function [Events,Info] = getevents(T,Q,R,varargin)">getevents</a>, findevents, <a href="eventfinder.html" class="code" title="function [T,Q,R,Info] = eventfinder(t,q,r,varargin)">eventfinder</a>, <a href="eventsplitter.html" class="code" title="function [T,Q,R,Info] = eventsplitter(t,q,r,varargin)">eventsplitter</a>, <a href="eventplotter.html" class="code" title="function [h,f] = eventplotter(T,Q,R,Info,varargin)">eventplotter</a>

 Matt Cooper, 04-Nov-2022, https://github.com/mgcooper</pre></div>


<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>

This function calls:
<ul style="list-style-image:url(../html_img/matlabicon.gif)">
</ul>


This function is called by:
<ul style="list-style-image:url(../html_img/matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<ul style="list-style-image:url(../html_img/matlabicon.gif)">

<li><a href="#_sub1" class="code">function Events = eventSelector(t,q,r,qdot,Info)</a></li>
<li><a href="#_sub2" class="code">function h = eventPlotter(t,q,r,dqdt,Info)</a></li>
<li><a href="#_sub3" class="code">function Events = updateEventPlot(Events,h)</a></li>
<li><a href="#_sub4" class="code">function [t, q, r, nmin, Info] = parseinputs(t, q, r, nmin, Info)</a></li></ul>



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [T,Q,R,Info] = eventpicker(t,q,r,nmin,Info)</a>
0002 <span class="comment">%EVENTPICKER automated or user-guided recession event selection</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Syntax</span>
0005 <span class="comment">%</span>
0006 <span class="comment">%     [T,Q,R,Info] = eventpicker(t,q,r,nmin,Info)</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% Description</span>
0009 <span class="comment">%</span>
0010 <span class="comment">%     [T,Q,R,Info] = eventpicker(t,q,r,nmin,Info) selects recession events from</span>
0011 <span class="comment">%     input hydrograph with time 't', discharge 'q', and rain 'r'. Use optional</span>
0012 <span class="comment">%     inputs to set parameters that determine how events are identified and</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% Required inputs</span>
0015 <span class="comment">%</span>
0016 <span class="comment">%     t        time</span>
0017 <span class="comment">%     q        flow (m3/time)</span>
0018 <span class="comment">%     r        rain (mm/time)</span>
0019 <span class="comment">%     nmin     minimum event length</span>
0020 <span class="comment">%</span>
0021 <span class="comment">% See also: getevents, findevents, eventfinder, eventsplitter, eventplotter</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% Matt Cooper, 04-Nov-2022, https://github.com/mgcooper</span>
0024 
0025 <span class="comment">% if called with no input, open this file</span>
0026 <span class="keyword">if</span> nargin == 0; open(mfilename(<span class="string">'fullpath'</span>)); <span class="keyword">return</span>; <span class="keyword">end</span>
0027 
0028 <span class="comment">% TODO: compare subfunction eventPlotter here to bfra.eventplotter and to</span>
0029 <span class="comment">% versions in dev-bk. Cursory glance - eventPlotter includes option to plot</span>
0030 <span class="comment">% rain, but does not include 3rd subplot of d2q/dt in bfra.eventplotter</span>
0031 
0032 <span class="comment">% PARSE INPUTS</span>
0033 [t, q, r, nmin, Info] = <a href="#_sub4" class="code" title="subfunction [t, q, r, nmin, Info] = parseinputs(t, q, r, nmin, Info)">parseinputs</a>(t, q, r, nmin, Info);
0034 
0035 
0036 <span class="comment">% compute the first derivative</span>
0037 qdot = bfra.deps.derivative(q);
0038 
0039 <span class="comment">% pick the events</span>
0040 Events = <a href="#_sub1" class="code" title="subfunction Events = eventSelector(t,q,r,qdot,Info)">eventSelector</a>(t,q,r,qdot,Info);
0041 numEvents = numel(Events.inputTime);
0042 
0043 <span class="comment">% apply quality control filters to the picked events</span>
0044 Q = cell(numEvents,1);
0045 T = cell(numEvents,1);
0046 R = cell(numEvents,1);
0047 Qdot = cell(numEvents,1);
0048 
0049 <span class="comment">% Note: this pulls T,Q,Q2 out of Events. Could change to send back Events</span>
0050 <span class="keyword">for</span> n = 1:numEvents
0051 
0052    qPick = Events.Q{n};
0053    tPick = Events.T{n};
0054    rPick = Events.R{n};
0055    qdotPick = Events.Qdot{n};
0056    
0057    rl = Events.runlengths(n);
0058    
0059    <span class="comment">% if the event is shorter than the min event criteria, skip it</span>
0060    <span class="keyword">if</span> rl&lt;nmin; numEvents = numEvents-1; <span class="keyword">continue</span>; <span class="keyword">end</span>
0061    
0062    <span class="comment">% islineconvex might be too restrictive, but without it, ETS call to</span>
0063    <span class="comment">% exponential fit sometimes fails, and nonlinear fitting will fail</span>
0064    <span class="keyword">if</span> bfra.util.islineconvex(qPick) || bfra.util.islineconvex(-diff(qPick))
0065       numEvents=numEvents-1;
0066       <span class="keyword">continue</span>
0067    <span class="keyword">end</span>
0068    
0069    <span class="comment">% otherwise, keep the pick</span>
0070    Q{n} = qPick;
0071    T{n} = tPick;
0072    R{n} = rPick;
0073    Qdot{n} = qdotPick;
0074 
0075 <span class="keyword">end</span>
0076 
0077 <span class="comment">% remove empty events</span>
0078 inan = false(size(T));
0079 <span class="keyword">for</span> n = 1:numel(T)
0080    <span class="keyword">if</span> isempty(T{n})
0081       inan(n) = true;
0082    <span class="keyword">end</span>
0083 <span class="keyword">end</span>
0084 
0085 T = T(~inan);
0086 Q = Q(~inan);
0087 R = R(~inan);
0088 Qdot = Qdot(~inan);
0089 
0090 <span class="comment">% replace the start/stop/runlengths with the picked ones</span>
0091 Info.istart = Events.istart;
0092 Info.istop = Events.istop;
0093 Info.runlengths = Events.runlengths;
0094 Info.hEvents = Events.h;
0095 
0096 Info.istart = Info.istart(~inan);
0097 Info.istop = Info.istop(~inan);
0098 Info.runlengths = Info.runlengths(~inan);
0099 
0100 <span class="comment">% close all</span>
0101 <span class="comment">% f = f(isgraphics(f)); close(f);</span>
0102 
0103 <span class="comment">%% local functions</span>
0104 <a name="_sub1" href="#_subfunctions" class="code">function Events = eventSelector(t,q,r,qdot,Info)</a>
0105 
0106 <span class="comment">% convert t to datenum for easier arithmetic</span>
0107 t = datenum(t);
0108 
0109 <span class="comment">% pick the points</span>
0110 h = <a href="#_sub2" class="code" title="subfunction h = eventPlotter(t,q,r,dqdt,Info)">eventPlotter</a>(t,q,r,qdot,Info);  <span class="comment">% plot the timeseries</span>
0111 
0112 pickedPts = bfra.deps.ginputc();
0113 startPts = pickedPts(1:2:end);
0114 endPts = pickedPts(2:2:end);
0115 numPicks = numel(startPts);
0116 
0117 <span class="comment">% initialize output</span>
0118 istart = nan(size(startPts));
0119 istop  = nan(size(startPts));
0120 rlengs = nan(size(startPts));
0121 T = cell(size(startPts));
0122 Q = cell(size(startPts));
0123 R = cell(size(startPts));
0124 Qdot = cell(size(startPts));
0125 
0126 <span class="keyword">for</span> n = 1:numPicks
0127    difStart = abs(t-startPts(n));
0128    difStop  = abs(t-endPts(n));
0129    istart(n) = bfra.util.findmin(difStart,1,<span class="string">'first'</span>);
0130    istop(n)  = bfra.util.findmin(difStop,1,<span class="string">'first'</span>);
0131    
0132    t_n = t(istart(n):istop(n));
0133    q_n = q(istart(n):istop(n));
0134    r_n = r(istart(n):istop(n));
0135    d_n = qdot(istart(n):istop(n));
0136    t_n = t_n(d_n~=0);
0137    q_n = q_n(d_n~=0);
0138    r_n = r_n(d_n~=0);
0139    d_n = d_n(d_n~=0);
0140    
0141    T{n} = t_n;
0142    Q{n} = q_n;
0143    R{n} = r_n;
0144    Qdot{n} = d_n;
0145    rlengs(n) = numel(q_n);
0146 <span class="keyword">end</span>
0147 
0148 Events.T = T;
0149 Events.Q = Q;
0150 Events.R = R;
0151 Events.Qdot = Qdot;
0152 Events.nEvents = numPicks;
0153 Events.istart = istart + Info.ifirst - 1;
0154 Events.istop = istop + Info.ifirst - 1;
0155 Events.runlengths = rlengs;
0156 
0157 <span class="comment">% some of the information in Info is relevant to the entire timeseries:</span>
0158 <span class="comment">% imaxima</span>
0159 <span class="comment">% iminima</span>
0160 <span class="comment">% iconvex</span>
0161 <span class="comment">% icandidate</span>
0162 <span class="comment">% ikeep</span>
0163 <span class="comment">% ifirst</span>
0164 
0165 <span class="comment">% some pertains to the automated selected events</span>
0166 <span class="comment">% istart</span>
0167 <span class="comment">% istop</span>
0168 <span class="comment">% runlengths</span>
0169 
0170 <span class="comment">% so we need to add a new field for picked events with:</span>
0171 <span class="comment">% istart</span>
0172 <span class="comment">% istop</span>
0173 <span class="comment">% runlengths</span>
0174 
0175 <span class="comment">% add the picked events to the plot</span>
0176 Events = <a href="#_sub3" class="code" title="subfunction Events = updateEventPlot(Events,h)">updateEventPlot</a>(Events,h);
0177 
0178 
0179 <a name="_sub2" href="#_subfunctions" class="code">function h = eventPlotter(t,q,r,dqdt,Info)</a>
0180    
0181 <span class="comment">% stripped down version of bfra.plotevents with ginput picking added</span>
0182 
0183 <span class="keyword">if</span> isempty(Info.istart)
0184    disp(<span class="string">'no valid events'</span>)
0185 <span class="keyword">end</span>
0186 
0187 h.Info = Info;
0188 ifirst = Info.ifirst(1);
0189 ikeep = Info.ikeep   - ifirst + 1;
0190 imax = Info.imaxima - ifirst + 1;
0191 imin = Info.iminima - ifirst + 1;
0192 icon = Info.iconvex - ifirst + 1;
0193 
0194 posidx = dqdt&gt;=0;
0195 negidx = dqdt&lt;0;
0196 sz = 20;
0197 
0198 <span class="comment">% new - add 50th percentil</span>
0199 q50 = quantile(q,0.5);
0200 
0201 <span class="comment">% make the figure</span>
0202 h.fig = figure(<span class="string">'Position'</span>,[1 1 1152 720]);
0203 h.sp1 = bfra.util.subtight(2,1,1,<span class="string">'style'</span>,<span class="string">'fitted'</span>);
0204 h.ax1 = gca;
0205 h.s1a = scatter(t(posidx),q(posidx),sz,<span class="string">'filled'</span>); hold on;
0206 h.s1b = scatter(t(negidx),q(negidx),sz,<span class="string">'filled'</span>); datetick;
0207 h.s1c = scatter(t(imax),q(imax),sz*2,<span class="string">'filled'</span>);
0208 h.s1d = scatter(t(imin),q(imin),sz*2,<span class="string">'filled'</span>);
0209 h.s1e = scatter(t(icon),q(icon),sz,<span class="string">'filled'</span>);
0210 h.s1f = scatter(t(ikeep),q(ikeep),sz*2.5,<span class="string">'filled'</span>);
0211 
0212 h.s1g = bfra.deps.hline(q50,<span class="string">':'</span>);
0213 
0214 dates = datetime(t,<span class="string">'ConvertFrom'</span>,<span class="string">'datenum'</span>);
0215 
0216 title(year(dates(1)))
0217 set(gca,<span class="string">'YScale'</span>,<span class="string">'log'</span>);
0218 
0219 h.l1 = legend(<span class="string">'increasing'</span>,<span class="string">'decreasing'</span>,<span class="string">'maxima'</span>,<span class="string">'minima'</span>,<span class="string">'convex'</span>, <span class="keyword">...</span>
0220    <span class="string">'keep'</span>,<span class="string">'keep (check)'</span>);
0221 
0222 ylabel(<span class="string">'Q'</span>);
0223 
0224 <span class="comment">% add rain</span>
0225 <span class="keyword">if</span> sum(r)&gt;0
0226    ax = gca;
0227    yyaxis right
0228    h.h1rain = bar(t,r,0.2,    <span class="string">'FaceColor'</span>,   [0.85 0.325 0.098],     <span class="keyword">...</span>
0229                               <span class="string">'FaceAlpha'</span>,   0.5,                    <span class="keyword">...</span>
0230                               <span class="string">'EdgeColor'</span>,   <span class="string">'none'</span>);
0231 
0232    ylabel(<span class="string">'rain (mm)'</span>,<span class="string">'Color'</span>,[0.85 0.325 0.098]);
0233    set(gca,<span class="string">'YColor'</span>,<span class="string">'k'</span>)
0234    datetick; axis(ax,<span class="string">'ij'</span>);
0235 <span class="keyword">end</span>
0236 
0237 
0238 <span class="comment">% plot -dq/dt in log</span>
0239 dqdt = -dqdt;
0240 
0241 h.sp2 = bfra.util.subtight(2,1,2,<span class="string">'style'</span>,<span class="string">'fitted'</span>);
0242 h.ax2 = gca;
0243 h.s2a = scatter(t(posidx),dqdt(posidx),sz,<span class="string">'filled'</span>); hold on;
0244 h.s2b = scatter(t(negidx),dqdt(negidx),sz,<span class="string">'filled'</span>);
0245 h.s2c = scatter(t(imax),dqdt(imax),sz*2,<span class="string">'filled'</span>);
0246 h.s2d = scatter(t(imin),dqdt(imin),sz*2,<span class="string">'filled'</span>);
0247 h.s2e = scatter(t(icon),dqdt(icon),sz,<span class="string">'filled'</span>);
0248 h.s2f = scatter(t(ikeep),dqdt(ikeep),sz*2.5,<span class="string">'filled'</span>);
0249 h.hl2 = bfra.deps.hline(0,<span class="string">'k-'</span>); h.hl2.LineWidth = 1;
0250 h.l2 = legend(<span class="string">'increasing'</span>,<span class="string">'decreasing'</span>,<span class="string">'maxima'</span>,<span class="string">'minima'</span>,<span class="string">'convex'</span>, <span class="keyword">...</span>
0251    <span class="string">'keep'</span>,<span class="string">'AutoUpdate'</span>,<span class="string">'off'</span>);
0252 ylabel(<span class="string">'dQ/dt'</span>);
0253 datetick
0254 set(gca,<span class="string">'YScale'</span>,<span class="string">'log'</span>);
0255 
0256 h.l1.Location = <span class="string">'best'</span>;
0257 h.l2.Location = <span class="string">'best'</span>;
0258 
0259    <span class="comment">% add rain</span>
0260 <span class="keyword">if</span> sum(r)&gt;0
0261    ax = gca;
0262    yyaxis right
0263    h.h2rain = bar(t,r,0.2,    <span class="string">'FaceColor'</span>,   [0.85 0.325 0.098],     <span class="keyword">...</span>
0264                               <span class="string">'FaceAlpha'</span>,   0.5,                    <span class="keyword">...</span>
0265                               <span class="string">'EdgeColor'</span>,   <span class="string">'none'</span>);
0266 
0267    ylabel(<span class="string">'rain (mm)'</span>,<span class="string">'Color'</span>,[0.85 0.325 0.098]);
0268    set(gca,<span class="string">'YColor'</span>,<span class="string">'k'</span>)
0269    datetick; axis(ax,<span class="string">'ij'</span>);
0270 <span class="keyword">end</span>
0271 
0272 
0273 <a name="_sub3" href="#_subfunctions" class="code">function Events = updateEventPlot(Events,h)</a>
0274    
0275 <span class="comment">% add the picked events to the plot</span>
0276 <span class="keyword">for</span> n = 1:Events.nEvents
0277 
0278    scatter(h.ax1,Events.T{n},Events.Q{n},60,<span class="string">'m'</span>);
0279    scatter(h.ax2,Events.T{n},Events.Qdot{n},60,<span class="string">'m'</span>);
0280    text(h.ax1,min(Events.T{n}),max(Events.Q{n}),[<span class="string">'Event '</span> num2str(n)]);
0281 
0282    <span class="keyword">if</span> n == 1
0283       h.l1.String{end} = <span class="string">'picked'</span>;
0284       h.l2.String{end+1} = <span class="string">'picked'</span>;
0285    <span class="keyword">else</span>
0286       h.l1.AutoUpdate = <span class="string">'off'</span>;
0287       h.l2.AutoUpdate = <span class="string">'off'</span>;
0288    <span class="keyword">end</span>
0289 <span class="keyword">end</span>
0290 
0291 Events.h = h;
0292 
0293 <span class="comment">%% INPUT PARSER</span>
0294 <a name="_sub4" href="#_subfunctions" class="code">function [t, q, r, nmin, Info] = parseinputs(t, q, r, nmin, Info)</a>
0295 
0296 parser = inputParser;
0297 parser.FunctionName = <span class="string">'bfra.eventpicker'</span>;
0298 parser.StructExpand = false; <span class="comment">% for 'Info' input</span>
0299 
0300 parser.addRequired(<span class="string">'t'</span>, @bfra.validation.isdatelike);
0301 parser.addRequired(<span class="string">'q'</span>, @isnumeric);
0302 parser.addRequired(<span class="string">'r'</span>, @isnumeric);
0303 parser.addRequired(<span class="string">'nmin'</span>, @bfra.validation.isnumericscalar);
0304 parser.addRequired(<span class="string">'Info'</span>, @isstruct);
0305 parser.parse(t, q, r, nmin, Info);
0306 
0307 t = parser.Results.t;
0308 q = parser.Results.q;
0309 r = parser.Results.r;
0310 nmin = parser.Results.nmin;
0311 Info = parser.Results.Info;
0312 assert(numel(q) == numel(t));</pre></div>
</body>
</html>