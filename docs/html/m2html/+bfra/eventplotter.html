<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of eventplotter</title>
  <meta name="keywords" content="eventplotter">
  <meta name="description" content="EVENTPLOTTER plot recession events detected by eventfinder">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../function_index.html">Home</a> &gt;  <a href="function_index.html">+bfra</a> &gt; eventplotter.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../function_index.html"><img alt="<" border="0" src="../html_img/left.png">&nbsp;Master index</a></td>
<td align="right"><a href="function_index.html">Index for +bfra&nbsp;<img alt=">" border="0" src="../html_img/right.png"></a></td></tr></table>-->

<h1>eventplotter
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<div class="box"><strong>EVENTPLOTTER plot recession events detected by eventfinder</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<div class="box"><strong>function [h,f] = eventplotter(T,Q,R,Info,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<div class="fragment"><pre class="comment">EVENTPLOTTER plot recession events detected by eventfinder

 Syntax

     h = eventplotter(t,q,r,Info,varargin)

 Description

     h = eventplotter(t,q,r,Info) Plots recession events identified by
     eventfinder on hydrograph t,q and rainfall r. Info is a structure returned
     by eventfinder that contains the indices of the start and end of each
     event as well as the local peaks, minimums, and runlength. An option to
     plot dq/dt as positive or negative values is available.

 Required inputs

     T        time
     Q        flow (m3/time)
     R        rain (mm/time)
     Info     Info structure returned by findevents.m

 Optional name-value inputs

  dqdt: user-provided dqdt, default = centered finite diff
  plotevents: logical, name-value e.g. 'plotevents',true
  plotneg: logical, name-value

 See also <a href="getevents.html" class="code" title="function [Events,Info] = getevents(T,Q,R,varargin)">getevents</a>, <a href="eventfinder.html" class="code" title="function [T,Q,R,Info] = eventfinder(t,q,r,varargin)">eventfinder</a>, <a href="eventpicker.html" class="code" title="function [T,Q,R,Info] = eventpicker(t,q,r,nmin,Info)">eventpicker</a>, <a href="eventsplitter.html" class="code" title="function [T,Q,R,Info] = eventsplitter(t,q,r,varargin)">eventsplitter</a>

 Matt Cooper, 04-Nov-2022, https://github.com/mgcooper</pre></div>


<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>

This function calls:
<ul style="list-style-image:url(../html_img/matlabicon.gif)">
</ul>


This function is called by:
<ul style="list-style-image:url(../html_img/matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<ul style="list-style-image:url(../html_img/matlabicon.gif)">

<li><a href="#_sub1" class="code">function [T, Q, R, Info, eventTags, plotneg, plotevents, dqdt] = parseinputs(T, Q, R, Info, varargin)</a></li></ul>



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [h,f] = eventplotter(T,Q,R,Info,varargin)</a>
0002 <span class="comment">%EVENTPLOTTER plot recession events detected by eventfinder</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Syntax</span>
0005 <span class="comment">%</span>
0006 <span class="comment">%     h = eventplotter(t,q,r,Info,varargin)</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% Description</span>
0009 <span class="comment">%</span>
0010 <span class="comment">%     h = eventplotter(t,q,r,Info) Plots recession events identified by</span>
0011 <span class="comment">%     eventfinder on hydrograph t,q and rainfall r. Info is a structure returned</span>
0012 <span class="comment">%     by eventfinder that contains the indices of the start and end of each</span>
0013 <span class="comment">%     event as well as the local peaks, minimums, and runlength. An option to</span>
0014 <span class="comment">%     plot dq/dt as positive or negative values is available.</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% Required inputs</span>
0017 <span class="comment">%</span>
0018 <span class="comment">%     T        time</span>
0019 <span class="comment">%     Q        flow (m3/time)</span>
0020 <span class="comment">%     R        rain (mm/time)</span>
0021 <span class="comment">%     Info     Info structure returned by findevents.m</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% Optional name-value inputs</span>
0024 <span class="comment">%</span>
0025 <span class="comment">%  dqdt: user-provided dqdt, default = centered finite diff</span>
0026 <span class="comment">%  plotevents: logical, name-value e.g. 'plotevents',true</span>
0027 <span class="comment">%  plotneg: logical, name-value</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% See also getevents, eventfinder, eventpicker, eventsplitter</span>
0030 <span class="comment">%</span>
0031 <span class="comment">% Matt Cooper, 04-Nov-2022, https://github.com/mgcooper</span>
0032 
0033 <span class="comment">% if called with no input, open this file</span>
0034 <span class="keyword">if</span> nargin == 0; open(mfilename(<span class="string">'fullpath'</span>)); <span class="keyword">return</span>; <span class="keyword">end</span>
0035 
0036 <span class="comment">% PARSE INPUTS</span>
0037 [T, Q, R, Info, eventTags, plotneg, plotevents, dqdt] = <span class="keyword">...</span>
0038    <a href="#_sub1" class="code" title="subfunction [T, Q, R, Info, eventTags, plotneg, plotevents, dqdt] = parseinputs(T, Q, R, Info, varargin)">parseinputs</a>(T, Q, R, Info, varargin{:});
0039 
0040 
0041 <span class="comment">% short circuits</span>
0042 <span class="keyword">if</span> plotevents == false; h = []; <span class="keyword">return</span>; <span class="keyword">end</span>
0043 <span class="keyword">if</span> isempty(Info.istart); disp(<span class="string">'no valid events'</span>); h = []; <span class="keyword">return</span>; <span class="keyword">end</span>
0044 
0045 <span class="comment">% otherwise, prep the data to plot</span>
0046 
0047 <span class="comment">% allow empty R i.e. input syntax eventplotter(T,Q,[],...)</span>
0048 <span class="keyword">if</span> isempty(R)
0049    R = zeros(size(T));
0050 <span class="keyword">end</span>
0051 
0052 sz = 20; <span class="comment">% this controls the size of the scatter symbols</span>
0053 
0054 <span class="comment">% compute the second derivative and the increasing/decreasing values. do this</span>
0055 <span class="comment">% here so the indices are relative to the same T,Q vectors as the Info indices</span>
0056 d2qdt = bfra.deps.derivative(dqdt);
0057 Info.ipositive = find(dqdt&gt;=0);
0058 Info.inegative = find(dqdt&lt;0);
0059 
0060 <span class="comment">% get the data for the requested events identified by their event tags</span>
0061 <span class="keyword">if</span> numel(eventTags) == N
0062    idx = 1:numel(T); <span class="comment">% all events were requested</span>
0063 <span class="keyword">else</span>
0064    <span class="comment">% create an index for the period of requested events padded by a week</span>
0065    idx = Info.istart(min(eventTags)):1:Info.istop(max(eventTags));
0066 
0067    <span class="comment">% this pads the indices by one week (or any other amount)</span>
0068    idx = [idx(1)-10:1:idx(1)-1 idx idx(end)+1:1:idx(end)+10];
0069 
0070    <span class="comment">% this uses all indices in the year(s) of this event(s)</span>
0071    <span class="comment">% idx = find(ismember(year(t),unique(year(t(idx)))));</span>
0072 <span class="keyword">end</span>
0073 
0074 fields = fieldnames(Info);
0075 <span class="keyword">for</span> n = 1:numel(fields)
0076    thisfield = Info.(fields{n});
0077    keep = ismember(thisfield,idx);
0078    Info.(fields{n}) = thisfield(keep);
0079 <span class="keyword">end</span>
0080 
0081 <span class="comment">% convert the first and second derivatives to positive values</span>
0082 <span class="keyword">if</span> plotneg == true
0083    dqdt = -dqdt;
0084    d2qdt = -d2qdt;
0085 <span class="keyword">end</span>
0086 
0087 <span class="comment">% fields to plot</span>
0088 plotfields = {<span class="string">'ipositive'</span>,<span class="string">'inegative'</span>,<span class="string">'imaxima'</span>,<span class="string">'iminima'</span>,<span class="string">'iconvex'</span>,<span class="string">'ikeep'</span>};
0089 
0090 <span class="comment">% turned this off so h is a gobjects array</span>
0091 <span class="comment">% h.Info = Info;</span>
0092 
0093 <span class="comment">% make the figure</span>
0094 <span class="comment">% h.f = figure('Position',[1,1,1152*2/3,616*2/3]);</span>
0095 f = figure(<span class="string">'Units'</span>,<span class="string">'inches'</span>,<span class="string">'Position'</span>,[1,1,8.5,5],<span class="string">'Visible'</span>,<span class="string">'on'</span>);
0096 <span class="comment">% tiledlayout(3,1,'TileSpacing','tight','Padding','tight');</span>
0097 
0098 <span class="comment">% plot the panels</span>
0099 <span class="keyword">for</span> m = 1:3
0100 
0101 <span class="comment">%    nexttile;</span>
0102    h.subplot(m) = bfra.util.subtight(3,1,m,<span class="string">'style'</span>,<span class="string">'fitted'</span>);
0103    h.ax(m) = gca; hold on;
0104 
0105    <span class="keyword">for</span> n = 1:numel(plotfields)
0106       
0107       thisfield = plotfields{n};
0108       ifield = Info.(thisfield);
0109    
0110       <span class="comment">% increase the plot symbol size depending on the field</span>
0111       <span class="keyword">switch</span> thisfield
0112          <span class="keyword">case</span> {<span class="string">'imaxima'</span>,<span class="string">'iminima'</span>}
0113             ssize = 2*sz;
0114          <span class="keyword">case</span> <span class="string">'ikeep'</span>
0115             ssize = 2.5*sz;
0116          <span class="keyword">otherwise</span>
0117             ssize = sz;
0118       <span class="keyword">end</span>
0119 
0120       <span class="keyword">switch</span> m
0121          <span class="keyword">case</span> 1 <span class="comment">% Q</span>
0122             h1.(thisfield) = scatter(h.ax(m),T(ifield),Q(ifield),ssize,<span class="string">'filled'</span>);
0123          <span class="keyword">case</span> 2 <span class="comment">% dQ/dt</span>
0124             h2.(thisfield) = scatter(h.ax(m),T(ifield),dqdt(ifield),ssize,<span class="string">'filled'</span>);
0125          <span class="keyword">case</span> 3 <span class="comment">% d2Q/dt2</span>
0126             h3.(thisfield) = scatter(h.ax(m),T(ifield),d2qdt(ifield),ssize,<span class="string">'filled'</span>);
0127       <span class="keyword">end</span>
0128       
0129    <span class="keyword">end</span>
0130 
0131    legend(<span class="string">'increasing'</span>,<span class="string">'decreasing'</span>,<span class="string">'maxima'</span>,<span class="string">'minima'</span>,<span class="string">'convex'</span>,<span class="string">'keep'</span>, <span class="keyword">...</span>
0132       <span class="string">'AutoUpdate'</span>,<span class="string">'off'</span>,<span class="string">'Orientation'</span>,<span class="string">'horizontal'</span>,<span class="string">'Location'</span>,<span class="string">'ne'</span>,<span class="keyword">...</span>
0133       <span class="string">'FontSize'</span>,10);
0134    
0135    set(gca,<span class="string">'FontSize'</span>,10)
0136 <span class="keyword">end</span>
0137 
0138 <span class="comment">% add labels</span>
0139 ylabel(h.ax(1),bfra.getstring(<span class="string">'Q'</span>,<span class="string">'units'</span>,true),<span class="string">'FontSize'</span>,10);
0140 ylabel(h.ax(2),bfra.getstring(<span class="string">'dQdt'</span>,<span class="string">'units'</span>,true),<span class="string">'FontSize'</span>,10);
0141 ylabel(h.ax(3),bfra.getstring(<span class="string">'d2Qdt2'</span>,<span class="string">'units'</span>,true),<span class="string">'FontSize'</span>,10);
0142 
0143 <span class="comment">% add a line at zero</span>
0144 h2.zeroline = plot(h.ax(2),xlim(h.ax(2)),[0 0],<span class="string">'k-'</span>,<span class="string">'LineWidth'</span>,1);
0145 h3.zeroline = plot(h.ax(3),xlim(h.ax(3)),[0 0],<span class="string">'k-'</span>,<span class="string">'LineWidth'</span>,1);
0146 
0147 h.h1 = h1;
0148 h.h2 = h2;
0149 h.h3 = h3;
0150 
0151 <span class="comment">%% INPUT PARSER</span>
0152 <a name="_sub1" href="#_subfunctions" class="code">function [T, Q, R, Info, eventTags, plotneg, plotevents, dqdt] = parseinputs(T, Q, R, Info, varargin)</a>
0153 
0154 parser = inputParser;
0155 parser.FunctionName = <span class="string">'bfra.eventplotter'</span>;
0156 
0157 N = numel(Info.istart);
0158 
0159 parser.addRequired(<span class="string">'T'</span>, @bfra.validation.isdatelike);
0160 parser.addRequired(<span class="string">'Q'</span>, @isnumeric);
0161 parser.addRequired(<span class="string">'R'</span>, @isnumeric);
0162 parser.addRequired(<span class="string">'Info'</span>, @isstruct);
0163 parser.addOptional(<span class="string">'eventTags'</span>, 1:N, @bfra.validation.isnumericvector);
0164 parser.addParameter(<span class="string">'plotneg'</span>, false, @bfra.validation.islogicalscalar);
0165 parser.addParameter(<span class="string">'plotevents'</span>, false, @bfra.validation.islogicalscalar);
0166 parser.addParameter(<span class="string">'dqdt'</span>, bfra.deps.derivative(Q), @isnumeric);
0167 
0168 parser.parse(T, Q, R, Info, varargin{:});
0169 
0170 T = parser.Results.T;
0171 Q = parser.Results.Q;
0172 R = parser.Results.R;
0173 Info = parser.Results.Info;
0174 dqdt = parser.Results.dqdt;
0175 plotneg = parser.Results.plotneg;
0176 plotevents = parser.Results.plotevents;
0177 eventTags = parser.Results.eventTags;
0178 
0179 assert(numel(Q) == numel(T))
0180 assert(numel(dqdt) == numel(T))
0181 
0182 <span class="comment">% if ispublishing</span>
0183 <span class="comment">%    exportgraphics(gcf,'html/event_example.png','Resolution',400);</span>
0184 <span class="comment">% end</span>
0185 
0186 <span class="comment">% snapnow</span>
0187 
0188 <span class="comment">% % other options not in use</span>
0189 <span class="comment">% %</span>
0190 <span class="comment">% % plot the 50th percentile as a reference line</span>
0191 <span class="comment">% % q50 = quantile(q,0.5);</span>
0192 <span class="comment">% % h1.refline = bfra.deps.hline(h.ax(1),q50,':'); % add the 50th quantile line</span>
0193 <span class="comment">%</span>
0194 <span class="comment">%</span>
0195 <span class="comment">% % plot the events identified by bfra.findevents, just to be sure</span>
0196 <span class="comment">% %     for i = 1:length(T)</span>
0197 <span class="comment">% %         h.s1g = scatter(T{i},Q{i},200,'r','LineWidth',2);</span>
0198 <span class="comment">% %     end</span>
0199 <span class="comment">% % h.l1 = legend('increasing','decreasing','maxima','minima','convex','keep','keep (check)');</span>
0200 <span class="comment">%</span>
0201 <span class="comment">% h.l1 = legend('increasing','decreasing','maxima','minima','convex','keep');</span>
0202 <span class="comment">% ylabel(bfra.getstring('Q','units',true));</span></pre></div>
</body>
</html>