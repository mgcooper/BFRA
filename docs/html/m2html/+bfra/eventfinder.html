<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of eventfinder</title>
  <meta name="keywords" content="eventfinder">
  <meta name="description" content="EVENTFINDER find recession events on hydrograph timeseries t,q and rainfall r">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../function_index.html">Home</a> &gt;  <a href="function_index.html">+bfra</a> &gt; eventfinder.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../function_index.html"><img alt="<" border="0" src="../html_img/left.png">&nbsp;Master index</a></td>
<td align="right"><a href="function_index.html">Index for +bfra&nbsp;<img alt=">" border="0" src="../html_img/right.png"></a></td></tr></table>-->

<h1>eventfinder
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<div class="box"><strong>EVENTFINDER find recession events on hydrograph timeseries t,q and rainfall r</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<div class="box"><strong>function [T,Q,R,Info] = eventfinder(t,q,r,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<div class="fragment"><pre class="comment">EVENTFINDER find recession events on hydrograph timeseries t,q and rainfall r

 Syntax

     [T,Q,R,Info] = eventfinder(t,q,r,varargin)

 Description

     [T,Q,R,Info] = eventfinder(t,q,r) Detects periods of declining flow on
     hydrographs defined by inputs time 't', discharge 'q', and rainfall 'r'.
     Use optional inputs to set parameters that determine how events are
     identified.

 Required inputs

     t           time
     q           flow (m3/time)
     r           rain (mm/time)

 Optional name-value inputs

     nmin        minimum event length
     fmax        maximum # of missing values gap-filled
     rmax        maximum run of sequential constant values
     rmin        minimum rainfall required to censor flow (mm/day?)
     rmconvex    remove convex derivatives
     rmnochange  remove consecutive constant derivates
     rmrain      remove rainfall

 See also <a href="getevents.html" class="code" title="function [Events,Info] = getevents(T,Q,R,varargin)">getevents</a>, <a href="eventsplitter.html" class="code" title="function [T,Q,R,Info] = eventsplitter(t,q,r,varargin)">eventsplitter</a>, <a href="eventpicker.html" class="code" title="function [T,Q,R,Info] = eventpicker(t,q,r,nmin,Info)">eventpicker</a>, <a href="eventplotter.html" class="code" title="function [h,f] = eventplotter(T,Q,R,Info,varargin)">eventplotter</a>

 Matt Cooper, 04-Nov-2022, https://github.com/mgcooper</pre></div>


<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>

This function calls:
<ul style="list-style-image:url(../html_img/matlabicon.gif)">
</ul>


This function is called by:
<ul style="list-style-image:url(../html_img/matlabicon.gif)">
</ul>
<!-- crossreference -->






<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../html_img/up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [T,Q,R,Info] = eventfinder(t,q,r,varargin)</a>
0002 <span class="comment">%EVENTFINDER find recession events on hydrograph timeseries t,q and rainfall r</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Syntax</span>
0005 <span class="comment">%</span>
0006 <span class="comment">%     [T,Q,R,Info] = eventfinder(t,q,r,varargin)</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% Description</span>
0009 <span class="comment">%</span>
0010 <span class="comment">%     [T,Q,R,Info] = eventfinder(t,q,r) Detects periods of declining flow on</span>
0011 <span class="comment">%     hydrographs defined by inputs time 't', discharge 'q', and rainfall 'r'.</span>
0012 <span class="comment">%     Use optional inputs to set parameters that determine how events are</span>
0013 <span class="comment">%     identified.</span>
0014 <span class="comment">%</span>
0015 <span class="comment">% Required inputs</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%     t           time</span>
0018 <span class="comment">%     q           flow (m3/time)</span>
0019 <span class="comment">%     r           rain (mm/time)</span>
0020 <span class="comment">%</span>
0021 <span class="comment">% Optional name-value inputs</span>
0022 <span class="comment">%</span>
0023 <span class="comment">%     nmin        minimum event length</span>
0024 <span class="comment">%     fmax        maximum # of missing values gap-filled</span>
0025 <span class="comment">%     rmax        maximum run of sequential constant values</span>
0026 <span class="comment">%     rmin        minimum rainfall required to censor flow (mm/day?)</span>
0027 <span class="comment">%     rmconvex    remove convex derivatives</span>
0028 <span class="comment">%     rmnochange  remove consecutive constant derivates</span>
0029 <span class="comment">%     rmrain      remove rainfall</span>
0030 <span class="comment">%</span>
0031 <span class="comment">% See also getevents, eventsplitter, eventpicker, eventplotter</span>
0032 <span class="comment">%</span>
0033 <span class="comment">% Matt Cooper, 04-Nov-2022, https://github.com/mgcooper</span>
0034 
0035 <span class="comment">% if called with no input, open this file</span>
0036 <span class="keyword">if</span> nargin == 0; open(mfilename(<span class="string">'fullpath'</span>)); <span class="keyword">return</span>; <span class="keyword">end</span>
0037 
0038 <span class="comment">%-------------------------------------------------------------------------------</span>
0039 p              = inputParser;
0040 p.FunctionName = <span class="string">'eventfinder'</span>;
0041 
0042 addRequired(p, <span class="string">'t'</span>,                  @(x) isnumeric(x) | isdatetime(x)     );
0043 addRequired(p, <span class="string">'q'</span>,                  @(x) isnumeric(x) &amp; numel(x)==numel(t));
0044 addRequired(p, <span class="string">'r'</span>,                  @(x) isnumeric(x)                     );
0045 addParameter(p,<span class="string">'nmin'</span>,        4,     @(x) isnumeric(x) &amp; isscalar(x) &amp; x&gt;2 );
0046 addParameter(p,<span class="string">'fmax'</span>,        2,     @(x) isnumeric(x) &amp; isscalar(x)       );
0047 addParameter(p,<span class="string">'rmax'</span>,        2,     @(x) isnumeric(x) &amp; isscalar(x)       );
0048 addParameter(p,<span class="string">'rmin'</span>,        0,     @(x) isnumeric(x) &amp; isscalar(x)       );
0049 addParameter(p,<span class="string">'rmconvex'</span>,    false, @(x) islogical(x) &amp; isscalar(x)       );
0050 addParameter(p,<span class="string">'rmnochange'</span>,  false, @(x) islogical(x) &amp; isscalar(x)       );
0051 addParameter(p,<span class="string">'rmrain'</span>,      false, @(x) islogical(x) &amp; isscalar(x)       );
0052 
0053 parse(p,t,q,r,varargin{:});
0054 
0055 nmin        = p.Results.nmin;
0056 fmax        = p.Results.fmax;
0057 rmax        = p.Results.rmax;
0058 rmin        = p.Results.rmin;
0059 rmconvex    = p.Results.rmconvex;
0060 rmnochange  = p.Results.rmnochange;
0061 rmrain      = p.Results.rmrain;
0062 
0063 <span class="comment">% allow empty r i.e. input syntax eventfinder(t,q,[],...)</span>
0064 <span class="keyword">if</span> isempty(r)
0065    r = zeros(size(t));
0066 <span class="keyword">end</span>
0067 
0068 <span class="comment">% convert to columns, in case this is not called from bfra.getevents</span>
0069 t = t(:);
0070 q = q(:);
0071 r = r(:);
0072 
0073 <span class="comment">%-------------------------------------------------------------------------------</span>
0074 
0075 
0076 iS = [1;find(diff(isnan(q))==-1)+1];       <span class="comment">% start non-nan segments</span>
0077 iE = [find(diff(isnan(q))==1);length(q)];  <span class="comment">% end non-nan segments</span>
0078 L  = iE-iS+1;                              <span class="comment">% segment lengths</span>
0079 
0080 <span class="comment">% initialize the combined events</span>
0081 T = []; Q = []; R = []; Info = struct; iflag = false;
0082 
0083 <span class="keyword">for</span> n = 1:length(iS)
0084    
0085    <span class="keyword">if</span> L(n)&lt;nmin                       <span class="comment">% set nan if &lt;nmin</span>
0086       [Tn,Qn,Rn,Infon] = bfra.util.setEventEmpty;
0087    <span class="keyword">else</span>
0088       tn = t(iS(n):iE(n));
0089       qn = q(iS(n):iE(n));
0090       rn = r(iS(n):iE(n));
0091       
0092       [Tn,Qn,Rn,Infon] = bfra.eventsplitter( <span class="keyword">...</span>
0093          tn,qn,rn, <span class="keyword">...</span>
0094          <span class="string">'nmin'</span>, nmin, <span class="keyword">...</span>
0095          <span class="string">'fmax'</span>, fmax, <span class="keyword">...</span>
0096          <span class="string">'rmax'</span>, rmax, <span class="keyword">...</span>
0097          <span class="string">'rmin'</span>, rmin, <span class="keyword">...</span>
0098          <span class="string">'rmrain'</span>, rmrain, <span class="keyword">...</span>
0099          <span class="string">'rmconvex'</span>, rmconvex, <span class="keyword">...</span>
0100          <span class="string">'rmnochange'</span>, rmnochange);
0101    <span class="keyword">end</span>
0102    
0103    <span class="comment">% if no events were detected, Infon.istart will be empty</span>
0104    <span class="keyword">if</span> all(isempty(Infon.istart)); <span class="keyword">continue</span>; <span class="keyword">else</span>
0105       
0106       <span class="comment">% iS is the start of the entire flow segment, but the indices in</span>
0107       <span class="comment">% Info are relative to the event returned by segmentevents. here</span>
0108       <span class="comment">% we add iS to these indices, except runlengths</span>
0109       fields = fieldnames(Infon);
0110       
0111       <span class="keyword">if</span> numel(Infon.ikeep) &gt; 0
0112          
0113          <span class="keyword">for</span> m = 1:numel(fields)
0114             Infon.(fields{m}) = Infon.(fields{m}) + iS(n) - 1;
0115          <span class="keyword">end</span>
0116          
0117          <span class="comment">% add the first non-nan index and runlengths to Info</span>
0118          <span class="comment">% Infon.ifirst = opts.ifirst;</span>
0119          <span class="comment">% Infon.runlengths = Infon.istop - Infon.istart + 1;</span>
0120       <span class="keyword">end</span>
0121       
0122       <span class="comment">% this is needed b/c 'info' has no fieldnames until first detected event</span>
0123       <span class="keyword">if</span> iflag == false           <span class="comment">% no events detected yet</span>
0124          T = Tn; Q = Qn; R = Rn; Info = Infon; iflag = true;
0125          <span class="keyword">continue</span>
0126       <span class="keyword">else</span>                        <span class="comment">% at least one detected event</span>
0127          T = [T;Tn];
0128          Q = [Q;Qn];
0129          R = [R;Rn];
0130          Info = bfra.util.catstructfields(1,Info,Infon);
0131       <span class="keyword">end</span>
0132    <span class="keyword">end</span>
0133 <span class="keyword">end</span>
0134 
0135 <span class="comment">% if no events were returned, set events empty</span>
0136 <span class="keyword">if</span> isempty(fieldnames(Info))
0137    [T,Q,R,Info] = bfra.util.setEventEmpty;
0138    
0139 <span class="keyword">else</span> <span class="comment">% cycle through and remove empty events</span>
0140    inan = false(size(T));
0141    <span class="keyword">for</span> n = 1:numel(T)
0142       <span class="keyword">if</span> isempty(T{n})
0143          inan(n) = true;
0144       <span class="keyword">end</span>
0145    <span class="keyword">end</span>
0146    T = T(~inan);
0147    Q = Q(~inan);
0148    R = R(~inan);
0149    
0150    Info.istart = Info.istart(~inan);
0151    Info.istop  = Info.istop(~inan);
0152    <span class="comment">% Info.runlengths = Info.runlengths(~inan);</span>
0153    
0154 <span class="keyword">end</span></pre></div>
</body>
</html>